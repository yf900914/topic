/**
 * Created by Lucien on 2016/9/15.
 */
var app = angular.module('app', ['ui.router', 'app.routes',
    'app.common.factory',
    'common.netService',
    'app.common.factory',
    'app.topiclist.controller',
    'app.topicdetail.controller'

]);

app.run(["netService", "$rootScope", function (netService, $rootScope) {
    return $rootScope.title = "话题列表";
}]);


/**
 * Created by Lucien on 2016/9/15.
 */
angular.module('app.routes',['ui.router']).config(["$stateProvider", "$httpProvider", function($stateProvider,$httpProvider){
    $httpProvider.defaults.headers.common["X-Requested-With"]='XMLHttpRequest';
    return $stateProvider.state('search',{
        url:'/search',
        template:'<topic-list></topic-list>',
        controller:'listController'
    }).state('detail',{
        url:'/detail/:id',
        template:'<topic-detail></topic-detail>',
        controller:'detailController'

    });
}]);

/**
 * Created by Lucien on 2016/9/16.
 */
angular.module('common.netService', [])
    .constant("config",{
        host:"http://localhost:9001"
    })
    .constant("apiUrl", {
        getTopic: '/topic/get',
        searchTopic: '/topic/search',
        addTopic: '/topic/add',
        deleteTopic: '/topic/delete'
    })
    .service('netService', ["$http", "apiUrl", "config", function ($http, apiUrl,config) {
    var $this, fn, url;
    $this = this;
    fn = function (url) {
        return $this[url] = function (method, data) {
            var opts;
            if (method.toLowerCase() === 'get' || method === 'delete') {
                opts = {
                    method: method,
                    url: config.host+apiUrl[url],
                    params: data
                };
            } else {
                opts = {
                    method: method,
                    url: config.host+apiUrl[url],
                    data: data
                };
            }
            return $http(opts);
        };
    };
    for (url in apiUrl) {
        fn(url);
    }
}]);

/**
 * Created by Lucien on 2016/9/16.
 */
angular.module('app.common.factory', []).factory('transferData', function () {
    var get, localStorage, set;
    localStorage = window.localStorage;
    set = function (key, data) {
        return localStorage[key] = JSON.stringify(data);
    };
    get = function (key) {
        if (localStorage[key]) {
            return JSON.parse(localStorage[key]);
        } else {
            return null;
        }
    };
    return {
        set: set,
        get: get
};
});

/**
 * Created by Lucien on 2016/9/15.
 */
angular.module('app.topiclist.directives.topiclist',['app.topiclist.directives.topic']).directive('topicList',function(){
    return {
        restrict:'EA',
        template:'<div class="topiclist">' +
        '<topic item="item" ng-repeat="item in topiclist"></topic>' +
        '</div>'
    }
})

/**
 * Created by Lucien on 2016/9/15.
 */
angular.module('app.topiclist.directives.topicitem',['app.topiclist.directives.topiclist']).directive('topicItem',function(){
    return {
        restrict:'EA',
        template:'<section class="topicitem">' +
            '<topic-item></topic-item>'+
        '</section>'
    }
})

/**
 * Created by Lucien on 2016/9/15.
 */
angular.module('app.topiclist.directives.topic',[]).directive('topic',function(){
    return {
        restrict:'EA',
        template:'<div class="topic">' +
        '<a  ui-sref="detail({id:item.id})"'+
        ' ng-style="{\'background-image\':\'url({{item.img}})\'} " class="topic-img">' +
        '<div class="cm-count-con">' +
        '<span class="cm-count-tip"></span><span class="cm-count">{{item.commentcount}}</span>'+
          '</div>'+
            '<div class="topic-titlte-con">'+
            '<h1 class="topic-title">{{item.title}}</h1>' +
            '</div>'+
        '</a>'+
        '</div>',
        scope:{item:"=item"}
    }
});

/**
 * Created by Lucien on 2016/9/21.
 */
//angular.module ('app.topicdetail.derective.comment',[]).directive ('comment',function(){
   // return {
      //  restrict:'EA',
        //template:'<div class="detail-comment"><div class="comment-side-con">' +
        //'<div class="pro-comment"></div><div class="con-comment"></div>' +
        //'</div>' +
          //  '<div class="comment-con"></div>'+
       // '</div>'
    //}
// })

/**
 * Created by Lucien on 2016/9/15.
 */
angular.module('app.topicdetail.directives.topicdetail',[]).directive('topicDetail',function(){
    return {
        restrict:'EA',
        template:'<div class="topic-detail-infor">' +
        '<div class="detail-con" ng-style="{\'background-image\':\'url(\' + topicinfo.img +\')\'}">' +
       '<h1 class="detail-title">{{topicinfo.title}}</h1>'+
        '</div>'+
        '<p class="detail-content">{{topicinfo.content}}</p>' +
            '<div class="support-side-con">' +
        '<section class="support-side">' +
        '<div class="pro-side">' +
        '<span class="pro-viewpoint">{{topicinfo.prosopinion}}</span>' +
        '</div>' +
         '<div class="vs-con">' +
        '<div class="vs"></div>' +
        '</div>'+
          '<div class="con-side">' +
        '<span class="con-viewpoint">{{topicinfo.consopinion}}</span>' +
        '</div>'+
        '</section>' +
            '<section class="comment-head">' +
        '<span class="all-comment-count">全部观点({{topicinfo.commentcount}})</span>' +
        '<span class="comment-filter"></span><ul class="viewpoint-side-con" style="display:none">' +
        '<li class="all-comment">全部</li>' +
        '<li class="support">蓝方</li>' +
        '<li class="oppose">红方</li>' +
        '</ul>' +
        '</section><section class="comment-con"><div></div></section>'+
        '</div>>'+
        '</div>'
    }
})

/**
 * Created by Lucien on 2016/9/16.
 */
angular.module('app.topiclist.controller', ['app.topiclist.directives.topiclist'])
    .controller('listController', ["$scope", "netService", function($scope, netService) {
        netService.searchTopic("post", {
            pagecount: 20
        }).success(function(body) {
            var data;
            if (body.errcode !== 0) {
                console.error("netService.addTask", body);
            }
            data = body.payload.rows;
            console.log(data);
           return $scope.topiclist = data;
        });
}]);

/**
 * Created by Lucien on 2016/9/20.
 */
angular.module('app.topicdetail.controller', ['app.topicdetail.directives.topicdetail'])
    .controller('detailController', ["$scope", "$stateParams", "netService", function ($scope, $stateParams, netService) {
       // console.log("debug");
        $scope.id=$stateParams.id;
        netService .getTopic ("get",{
            id:$scope.id
        }).success(function(body){
            var data;
            if (body.errcode !== 0) {
                console.error("netService.addTask", body);
            }
            data=body.payload;
            //console.log(data);
            $scope.topicinfo=data;
            console.log ($scope.topicinfo);
        });
    }]);
